angular.module("ui.colorpicker",[]).value("colorpicker.language",{"zh-cn":{PALETTE:"经典",WHEEL:"自定义",HISTORY:"历史记录",SELECT:"选择",CANCEL:"取消"},"zh-tw":{PALETTE:"經典",WHEEL:"自定義",HISTORY:"歷史記錄",SELECT:"選擇",CANCEL:"取消"},en:{PALETTE:"Palette",WHEEL:"Wheel",HISTORY:"History",SELECT:"Select",CANCEL:"Cancel"},fr:{PALETTE:"Palette",WHEEL:"Roue",HISTORY:"Historique",SELECT:"Sélectionner",CANCEL:"Annuler"},pt:{PALETTE:"Paleta",WHEEL:"Personalizar",HISTORY:"Recentes",SELECT:"Selecionar",CANCEL:"Cancelar"}}).factory("colorpicker.helper",["$document",function(o){return{setCookie:function(o,e){var t=30,r=new Date;r.setTime(r.getTime()+24*t*60*60*1e3),document.cookie=o+"="+escape(e)+";expires="+r.toGMTString()},getCookie:function(o){var e,t=new RegExp("(^| )"+o+"=([^;]*)(;|$)");return(e=document.cookie.match(t))?unescape(e[2]):null},deleteCookie:function(o){var e=new Date;e.setTime(e.getTime()-1);var t=getCookie(o);null!=t&&(document.cookie=o+"="+t+";expires="+e.toGMTString())},enabledCookie:function(o){return"string"==typeof this.getCookie(o)},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(o){return[o[1],o[2],o[3],o[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(o){return[2.55*o[1],2.55*o[2],2.55*o[3],o[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(o){return[parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(o){return[parseInt(o[1]+o[1],16),parseInt(o[2]+o[2],16),parseInt(o[3]+o[3],16)]}}]}}]).factory("colorpicker.transColor",["colorpicker.helper",function(o){return{value:{h:1,s:1,b:1,a:1},rgb:function(){var o=this.toRGB();return"rgb("+o.r+","+o.g+","+o.b+")"},rgba:function(){var o=this.toRGB();return"rgba("+o.r+","+o.g+","+o.b+","+o.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(o,e,t,r){o/=255,e/=255,t/=255;var i,n,a,l;return a=Math.max(o,e,t),l=a-Math.min(o,e,t),i=0===l?null:a===o?(e-t)/l:a===e?(t-o)/l+2:(o-e)/l+4,i=(i+360)%6*60/360,n=0===l?0:l/a,{h:i||1,s:n,b:a,a:r||1}},setColor:function(e){e=e.toLowerCase();for(var t in o.stringParsers)if(o.stringParsers.hasOwnProperty(t)){var r=o.stringParsers[t],i=r.re.exec(e),n=i&&r.parse(i);if(n)return this.value=this.RGBtoHSB.apply(null,n),!1}},setHue:function(o){this.value.h=1-o},setSaturation:function(o){this.value.s=o},setLightness:function(o){this.value.b=1-o},setAlpha:function(o){this.value.a=parseInt(100*(1-o),10)/100},toRGB:function(o,e,t,r){o||(o=this.value.h,e=this.value.s,t=this.value.b),o*=360;var i,n,a,l,s;return o=o%360/60,s=t*e,l=s*(1-Math.abs(o%2-1)),i=n=a=t-s,o=~~o,i+=[s,l,0,0,l,s][o],n+=[l,s,s,l,0,0][o],a+=[0,0,l,s,s,l][o],{r:Math.round(255*i),g:Math.round(255*n),b:Math.round(255*a),a:r||this.value.a}},toHex:function(o,e,t,r){var i=this.toRGB(o,e,t,r);return"#"+(1<<24|parseInt(i.r,10)<<16|parseInt(i.g,10)<<8|parseInt(i.b,10)).toString(16).substr(1)}}}]).factory("colorpicker.slider",function(){"use strict";var o={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},e={};return{getOffset:function(o){for(var e=0,t=0,r=o.getBoundingClientRect();o&&!isNaN(o.offsetLeft)&&!isNaN(o.offsetTop);)"BODY"===o.tagName?(e+=document.documentElement.scrollLeft||o.scrollLeft,t+=document.documentElement.scrollTop||o.scrollTop):(e+=o.scrollLeft,t+=o.scrollTop),o=o.offsetParent;return{top:r.top+window.pageYOffset,left:r.left-130+window.pageXOffset,scrollX:e,scrollY:t}},closestSlider:function(o){var e=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.msMatchesSelector;return e.bind(o)("I")?o.parentNode:o},getSlider:function(){return o},getLeftPosition:function(t){return Math.max(0,Math.min(o.maxLeft,o.left+((t.pageX||e.left)-e.left)))},getTopPosition:function(t){return Math.max(0,Math.min(o.maxTop,o.top+((t.pageY||e.top)-e.top)))},setSlider:function(t){var r=this.closestSlider(t.target),i=this.getOffset(r),n=r.getBoundingClientRect(),a=t.clientX-n.left,l=t.clientY-n.top;o.knob=r.children[0].style,o.left=t.pageX-i.left-window.pageXOffset+i.scrollX,o.top=t.pageY-i.top-window.pageYOffset+i.scrollY,e={left:t.pageX-(a-o.left),top:t.pageY-(l-o.top)}},setSaturation:function(e){o={maxLeft:200,maxTop:200,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e)},setHue:function(e){o={maxLeft:0,maxTop:200,callLeft:!1,callTop:"setHue"},this.setSlider(e)},setAlpha:function(e){o={maxLeft:0,maxTop:200,callLeft:!1,callTop:"setAlpha"},this.setSlider(e)},setKnob:function(e,t){o.knob.top=e+"px",o.knob.left=t+"px"}}}).directive("colorpicker",["$document","$compile","colorpicker.language","colorpicker.transColor","colorpicker.slider","colorpicker.helper",function(o,e,t,r,i,n){"use strict";return{restrict:"AE",replace:!0,scope:{color:"=",selectNewCallback:"&onSelectNew"},template:'<div class="colorpicker-circle">    <div class="circle-inner" ng-style="{\'background-color\':color}"></div></div>',link:function(a,l,s,c){function u(){clearTimeout(S),S=setTimeout(function(){m.css(B()),clearTimeout(S)},100)}a.show=!1,a.colorTab=1,a.colorboxs=["rgba(81,167,249,1)","rgba(112,191,65,1)","rgba(245,211,40,1)","rgba(243,144,25,1)","rgba(236,93,87,1)","rgba(179,106,226,1)","rgba(3,101,192,1)","rgba(0,136,43,1)","rgba(220,189,35,1)","rgba(222,106,16,1)","rgba(200,37,6,1)","rgba(119,63,155,1)","rgba(22,79,134,1)","rgba(11,93,24,1)","rgba(195,151,26,1)","rgba(189,91,12,1)","rgba(134,16,1,1)","rgba(95,50,124,1)","rgba(0,36,82,1)","rgba(5,65,9,1)","rgba(163,117,18,1)","rgba(146,70,7,1)","rgba(87,7,6,1)","rgba(59,31,78,1)","rgba(255,255,255,1)","rgba(220,222,224,1)","rgba(166,170,169,1)","rgba(114,114,114,1)","rgba(83,88,95,1)","rgba(0,0,0,1)"],a.historyColorboxs=[];var f=t[s.colorLanguage||"zh-cn"],p=a.format=s.colorType||"hex",d="historyColor-"+p,g=angular.element(document.body),v='<div class="colorpicker-mask" ng-show="show" ng-click="select()"></div><div class="colorpicker dropdown" ng-show="show">     <div class="colorpicker-preview">       <div class="inner">       <div class="color-text"></div>       <div class="color-tabs">        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 1]" ng-click="toggleTab(1)">'+f.PALETTE+'</div>        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 2]" ng-click="toggleTab(2)">'+f.WHEEL+'</div>        <div class="color-tab" ng-class="{true: \'active\', false: \'\'}[colorTab === 3]" ng-click="toggleTab(3)">'+f.HISTORY+'</div>       </div>       </div>     </div>     <div class="tab-colorbox" ng-show="colorTab ===1">       <div ng-repeat="item in colorboxs">          <div class="color-unit" ng-attr-style="background-color:{{::item}}" ng-class="{true:\'active\',false:\'\'}[color === item]" ng-click="selectColorBox(item,$index)"></div>       </div>     </div>     <div class="tab-slider" ng-show="colorTab ===2">       <div class="colorpicker-saturation"><i></i></div>       <div class="colorpicker-hue"><i></i></div>       <div ng-show="format === \'rgba\'" class="colorpicker-alpha"><i></i></div>     </div>     <div class="tab-historyColorbox" ng-show="colorTab ===3">       <div ng-repeat="item in historyColorboxs">           <div class="color-unit-wrap">               <div class="color-unit" ng-attr-style="background-color:{{::item}}" ng-class="{true:\'active\',false:\'\'}[color === item]" ng-click="selectColorBox(item,$index)"></div>           </div>       </div>     </div>     <div class="btn-group">        <div class="cancel" ng-click="cancel()">'+f.CANCEL+'</div>        <div class="select" ng-click="select()">'+f.SELECT+'</div>     </div>     <div class="colorpicker-caret"></div></div>',b=angular.element(v),h=b.eq(0),m=b.eq(1),k=m.find(".colorpicker-hue"),C=m.find(".colorpicker-saturation"),T=m.find(".colorpicker-preview"),w=m.find("i"),x=m.find(".colorpicker-caret");e(b)(a),g.append(b);var E,L,S,A=r,H=24;a.toggleTab=function(o){a.colorTab=o,N()},a.selectColorBox=function(o,e){A.setColor(o),a.color=A[p](),P()},a.cancel=function(){a.color=L,Y("cancel")},a.select=function(){a.selectNewCallback&&a.color!==L&&a.selectNewCallback(),Y()};var y=function(){o.on("mousemove",I),o.on("mouseup",R)};"rgba"===p&&(m.addClass("alpha"),E=m.find(".colorpicker-alpha"),E.on("click",function(o){i.setAlpha(o),I(o)}).on("mousedown",function(o){i.setAlpha(o),y()})),k.on("click",function(o){i.setHue(o),I(o)}).on("mousedown",function(o){i.setHue(o),y()}),C.on("click",function(o){i.setSaturation(o),I(o)}).on("mousedown",function(o){i.setSaturation(o),y()});var P=function(){var o=A.value.b>.5?"#000000":"#FFFFFF",e=A[p]();T.find(".color-text").text(e),T.find(".inner").css("backgroundColor",e),T.find(".color-tabs").css("color",o),T.find(".color-text").css("color",o),C.css("backgroundColor",A.toHex(A.value.h,1,1,1)),m.hasClass("position-left")||m.hasClass("position-right")?x.css("border-color",e):x.css("border-color","#fff")},I=function(o){var e=i.getLeftPosition(o),t=i.getTopPosition(o),r=i.getSlider();i.setKnob(t,e),r.callLeft&&A[r.callLeft].call(A,e/200),r.callTop&&A[r.callTop].call(A,t/200),P();var n=A[p]();return m.find(".colorpicker-alpha").css({"background-color":n}),a.$apply(function(){a.color=n}),!1},R=function(){o.off("mousemove",I),o.off("mouseup",R)},N=function(){var o=A[p]();A.setColor(o),w.eq(0).css({left:200*A.value.s+"px",top:200-200*A.value.b+"px"}),m.find(".colorpicker-alpha").css({"background-color":o}),w.eq(1).css("top",200*(1-A.value.h)+"px"),w.eq(2).css("top",200*(1-A.value.a)+"px"),P()},B=function(){var o,e=m.width(),t=m.height(),r=l[0].getBoundingClientRect(),i=r.left,n=r.top,a=($(window).width(),$(window).height());return m.removeClass("position-top"),m.removeClass("position-right"),m.removeClass("position-bottom"),m.removeClass("position-left"),i>e&&a-n>=t?(o={top:n-6,left:i-e+10},m.addClass("position-left")):i<e&&a-n>=t?(o={top:n-6,left:i+20},m.addClass("position-right")):i>e&&a-n<t?(o={top:n-t+35,left:i-e+10},m.addClass("position-top")):(o={top:n-t+35,left:i+20},m.addClass("position-bottom")),{top:o.top+"px",left:o.left+"px"}},M=function(o){L=angular.copy(a.color),A.setColor(L),N();var e=n.getCookie(d);e=null===e?[]:e.split("|"),a.$apply(function(){a.show=!0,a.historyColorboxs=e}),m.css(B()),h.css({"z-index":parseInt((new Date).getTime(),10)}),m.css({"z-index":parseInt((new Date).getTime(),10)})};l.on("click",M),m.on("mousedown",function(o){o.stopPropagation(),o.preventDefault()});var Y=function(o){a.show=!1,"cancel"!==o&&O()},O=function(){var o=A[p]();if(n.enabledCookie(d)){for(var e=n.getCookie(d),t=e.split("|"),r=0;r<t.length;r++)if(o===t[r])return t.splice(r,1),t.unshift(o),void n.setCookie(d,t.join("|"));t.length>=H?(t.pop(),t.unshift(o),n.setCookie(d,t.join("|"))):n.setCookie(d,o+"|"+e)}else n.setCookie(d,o)};o.bind("scroll",function(){u()}),$(window).on("resize",function(){u()})}}}]);